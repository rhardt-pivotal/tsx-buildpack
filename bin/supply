#!/bin/sh
# set -e
set -x
if [ -z ${TSX_TAR_URI+x} ]
then
  echo "TSX_TAR_URI env var not set"
  exit 1
fi
if [ -z ${TSX_ARGS+x} ]
then
  echo "TSX_ARGS not set"
  exit 1
fi

echo "**  Running modified install script"

wget $TSX_TAR_URI --quiet -O ./tsx.tar

ls -al

mkdir $3/$4/tsx
tar xf tsx.tar -C $3/$4/tsx --strip-components 1 



SCRIPTS_DIR="$( cd "$(dirname "$0")" ; pwd -P )/../scripts"
$SCRIPTS_DIR/bp_install.sh $3/$4/tsx


cat <<'EOF' >> $3/$4/launch.yml
#!/usr/bin/env bash
---
processes:
- type: "sidecar_process"
  command: "while true; do echo hello from a sidecar process; sleep 10; done"
  platforms:
    cloudfoundry:
      sidecar_for: [ "web"]
EOF





cat <<'EOF' >> $3/$4/bin/tsx_install.sh
#!/usr/bin/env bash
LOG=/tmp/tsx_install.log
SCRIPT_DIR="$( dirname "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )" )"
echo "\"$SCRIPT_DIR\""
echo "downloading to $SCRIPT_DIR" >>$LOG
cd "$SCRIPT_DIR"
wget $TSX_TAR_URI --quiet -O ./tsx.tar >>$LOG 2>&1
mkdir ./tsx
tar xf tsx.tar -C tsx --strip-components 1 >>$LOG 2>&1
cd ./tsx
./install.sh >>$LOG 2>&1
$HOME/../tsx/bin/tsx ${TSX_ARGS} >>$LOG 2>&1
EOF

chmod +x $3/$4/bin/tsx_install.sh

cat <<EOF >> $3/$4/config.yml
--- 
name: tsx_buildpack
config:
  java_opts:
    preformatted_options: ["-Dscript_2=\$($HOME/$3/$4/bin/tsx_install.sh)"]
  environment_variables:
    "PATH": "$HOME/tsx/bin:\$PATH"
    "LD_PRELOAD": "$HOME/tsx/lib/tsx64.so"
EOF
